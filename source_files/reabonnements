:name: Réabonnements

:description: Trouver les tiers qui ne sont pas abonnés à la revue choisie l'année
  de référence, mais qui l'étaient l'année précédente.<br>
  Cette année est à renseigner, ainsi que la revue.<br>
  Le format de sortie comporte l'identifiant du tiers, le nom de la revue, le type de l'abonnement.

:query: SELECT
  TIERS_DESC, revue_nom, type_abonnement_nom, abo1.abonnement_annee
  FROM tiers
  LEFT JOIN client_sage AS client1
    ON client1.client_sage_client_final = tiers_id
  LEFT JOIN abonnement AS abo1
    ON abo1.abonnement_client_sage = client1.client_sage_id
  LEFT JOIN type_abonnement
    ON abo1.abonnement_type = type_abonnement_id
  LEFT JOIN revue
    ON abo1.abonnement_revue = revue_id
  WHERE
    tiers.tiers_etat=1
    AND (abo1.abonnement_ignorer = 0 OR abo1.abonnement_ignorer IS NULL)
    AND abo1.abonnement_annee CONDITION-1
    AND revue_nom LIKE PARAM
    AND NOT EXISTS
      (SELECT * FROM abonnement AS abo2
      LEFT JOIN client_sage AS client2
        ON abo2.abonnement_client_sage = client2.client_sage_id
      WHERE client2.client_sage_client_final = tiers_id
       AND (abo2.abonnement_ignorer = 0 OR abo2.abonnement_ignorer IS NULL)
       AND abo2.abonnement_annee = abo1.abonnement_annee + 1
       AND abo2.abonnement_revue = abo1.abonnement_revue
      )

:years: simple

:parameter_list:
- '%'
- 'Bulletin'
- 'Annales%'
- 'Mémoires'
- '%Histoire%'
